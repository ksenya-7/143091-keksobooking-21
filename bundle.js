(()=>{"use strict";window.utils={isEscape:e=>"Escape"===e.key,isEnter:e=>"Enter"===e.key},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o={400:"Неверный запрос",401:"Пользователь не авторизован",404:"Ничего не найдено",500:"Internal Server Error"},r=(e,t,r)=>{let n;switch(e.status){case 200:t(e.response);break;case e.status:n=o[e.status];break;default:n="Cтатус ответа: : "+e.status+" "+e.statusText}n&&r(n)},n=(e,t,o,n,a)=>{const l=new XMLHttpRequest;l.responseType="json",l.addEventListener("load",r.bind(null,l,t,o)),l.timeout=5e3,l.addEventListener("timeout",(()=>{o("Запрос не успел выполниться за "+l.timeout+"мс")})),l.addEventListener("error",(()=>{window.error.onLoadErrorMessage()})),l.open(e,n),l.send(a)};window.backend={load:(t,o)=>{n("GET",t,o,e)},save:(e,o,r)=>{n("POST",o,r,t,e)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=o.querySelector(".error__button"),n=o.querySelector(".error__message"),a=(e,t,o)=>{e.remove(),document.removeEventListener("keydown",t),document.removeEventListener("mousedown",o)},l=e=>{window.utils.isEscape(e)&&(e.preventDefault(),a(t,l,d))},d=e=>{e.preventDefault(),a(t,l,d)},s=()=>{a(o,c,u)},c=e=>{window.utils.isEscape(e)&&(e.preventDefault(),a(o,c,u))},u=e=>{e.preventDefault(),a(o,c,u)};window.error={onLoadSuccessMessage:()=>{e.append(t),document.addEventListener("keydown",l),document.addEventListener("mousedown",d)},onLoadErrorMessage:t=>{n.textContent=t,e.append(o),r.addEventListener("click",s),document.addEventListener("keydown",c),document.addEventListener("mousedown",u)},onLoadFormErrorMessage:()=>{var t,n,a,l,d;t=o,n=r,a=s,l=c,d=u,e.append(t),n.addEventListener("click",a),document.addEventListener("keydown",l),document.addEventListener("mousedown",d)}}})(),(()=>{let e=null,t=null;const o=t=>{window.utils.isEscape(t)&&e.classList.add("hidden"),document.removeEventListener("keydown",o),document.removeEventListener("click",r)},r=()=>{e.remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",r)};window.openCards=(n,a)=>{let l=n.slice();for(let n=0;n<a.length;n++)a[n].addEventListener("click",(()=>{null!==e&&e.remove(),window.renderCard(l[n]),e=document.querySelector(".map__card"),t=e.querySelector(".popup__close"),t.addEventListener("click",r),document.addEventListener("keydown",o)}))}})(),(()=>{const e=["popup__title","popup__text--address","popup__text--price","popup__type","popup__text--capacity","popup__text--time","popup__features","popup__description","popup__photos","popup__avatar"],t=document.querySelector(".map__filters-container"),o=document.querySelector("#card").content.querySelector(".map__card"),r=o.querySelector(".popup__photo"),n={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};window.renderCard=a=>{const l=o.cloneNode(!0);l.querySelector(".popup__title").textContent=a.offer.title,l.querySelector(".popup__text--address").textContent=a.offer.address,l.querySelector(".popup__text--price").textContent=a.offer.price+"₽/ночь",l.querySelector(".popup__type").textContent=n[a.offer.type],l.querySelector(".popup__text--capacity").textContent=`${a.offer.rooms} комнаты для ${a.offer.guests} гостей.`,l.querySelector(".popup__text--time").textContent=`Заезд после ${a.offer.checkin}, выезд до ${a.offer.checkout}.`,l.querySelector(".popup__features").innerHTML="",((e,t)=>{const o=document.createDocumentFragment();e.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),o.append(t)})),t.append(o)})(a.offer.features,l.querySelector(".popup__features")),l.querySelector(".popup__description").textContent=a.offer.description,l.querySelector(".popup__photos").innerHTML="",((e,t)=>{const o=document.createDocumentFragment();e.forEach((e=>{const t=r.cloneNode(!0);t.src=e,o.append(t)})),t.append(o)})(a.offer.photos,l.querySelector(".popup__photos")),e.forEach((e=>{""===l.querySelector("."+e).innerHTML&&(l.querySelector("."+e).style.display="none")})),l.querySelector(".popup__avatar").src=a.author.avatar,l.querySelector(".popup__avatar").style.display="block",t.insertAdjacentElement("beforeBegin",l)}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=e=>{const t=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);return t.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px;`,t.querySelector("img").src=e.author.avatar,t.querySelector("img").alt=e.offer.title,null===e.offer||void 0===e.offer?null:t};window.renderPins=o=>{const r=o.slice(0,5);document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove())),document.querySelectorAll(".popup").forEach((e=>e.remove()));const n=document.createDocumentFragment();r.map(t).forEach((e=>n.append(e))),e.append(n);const a=document.querySelectorAll(".map__pin:not(.map__pin--main)");window.openCards(o,a)}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address");e.addEventListener("mousedown",(o=>{o.preventDefault();let r={x:o.clientX,y:o.clientY};const n=(e,t)=>Math.floor(parseInt(e,10)+32.5)+", "+Math.floor(parseInt(t,10)+87),a=o=>{o.preventDefault();let a=r.x-o.clientX,l=r.y-o.clientY;r={x:o.clientX,y:o.clientY},e.offsetTop-l>543?e.style.top="543px":e.offsetTop-l<43?e.style.top="43px":(e.style.top=e.offsetTop-l+"px",t.value=n(e.style.left,e.style.top)),e.offsetLeft-a>1168.5?e.style.left="1168.5px":e.offsetLeft-a<-32.5?e.style.left="-32.5px":(e.style.left=e.offsetLeft-a+"px",t.value=n(e.style.left,e.style.top))},l=o=>{o.preventDefault(),t.value=n(e.style.left,e.style.top),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}))})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),a=e.querySelector("#housing-features"),l=e=>"any"===t.value||t.value===e.offer.type,d=e=>{const t=parseInt(e.offer.price,10);let r=!0;switch(o.value){case"any":r=!0;break;case"middle":r=t>=1e4&&t<=5e4;break;case"low":r=t<1e4;break;case"high":r=t>5e4}return r},s=e=>"any"===r.value||parseInt(r.value,10)===e.offer.rooms,c=e=>"any"===n.value||parseInt(n.value,10)===e.offer.guests,u=e=>{const t=e.offer.features,o=a.querySelectorAll("input[type=checkbox]:checked");return[].map.call(o,(e=>e.value)).every((e=>t.includes(e)))},i=window.debounce(window.renderPins);window.filtersHandler=t=>{e.addEventListener("change",(()=>{const e=t.filter(l).filter(d).filter(s).filter(c).filter(u);i(e)}))}})(),(()=>{const e=document.querySelectorAll(".map__filter"),t=document.querySelectorAll(".map__checkbox"),o={LEFT:parseInt(document.querySelector(".map__pin--main").style.left,10)+32.5,TOP_INITIAL:parseInt(document.querySelector(".map__pin--main").style.top,10)+32.5,TOP:parseInt(document.querySelector(".map__pin--main").style.top,10)+87},r=e=>{for(let t of e)"INPUT"===t.tagName?t.setAttribute("disabled","disabled"):t.setAttribute("disabled","true")};window.disactivatePage=()=>{document.querySelector(".ad-form").classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove())),r(document.querySelector(".ad-form").children),r(e),r(t),document.querySelector("#address").value=Math.round(o.LEFT)+", "+Math.round(o.TOP_INITIAL),document.querySelector(".map__pin--main").style.left="570px",document.querySelector(".map__pin--main").style.top="375px",document.querySelector("#address").setAttribute("readonly","readonly"),document.querySelector(".ad-form-header__preview img").src="img/muffin-grey.svg",document.querySelectorAll(".ad-form__photo").forEach((e=>{e.hasChildNodes()&&e.remove()})),document.querySelector(".map__pin--main").addEventListener("mousedown",window.onMouseDown)}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),o=t.querySelector("#title"),r=t.querySelector("#type"),n=t.querySelector("#price"),a=t.querySelector("#capacity"),l=t.querySelector("#room_number"),d=t.querySelector("#timein"),s=t.querySelector("#timeout"),c=t.querySelector(".ad-form-header__input"),u=t.querySelector(".ad-form-header__preview img"),i=t.querySelector(".ad-form__photo-container"),p=t.querySelector(".ad-form__input"),m=t.querySelector(".ad-form__photo").cloneNode(!0);t.querySelector(".ad-form__photo").style.display="none";const y={bungalow:0,flat:1e3,house:5e3,palace:1e4},_={bungalow:"«Бунгало» — минимальная цена за ночь 0",flat:"«Квартира» — минимальная цена за ночь 1 000",house:"«Дом» — минимальная цена 5 000",palace:"«Дворец» — минимальная цена 10 000"},f={1:"1 комната — «для 1 гостя»",2:"2 комнаты — «для 2 гостей» или «для 1 гостя»",3:"3 комнаты — «для 3 гостей», «для 2 гостей» или «для 1 гостя»",100:"100 комнат — «не для гостей»"},v={1:[1],2:[1,2],3:[1,2,3],100:[0]};let S=!0;c.addEventListener("change",(()=>{const t=c.files[0],o=t.name.toLowerCase();if(u.src="",S=e.some((e=>o.endsWith(e))),S){const e=new FileReader;e.addEventListener("load",(()=>{u.src=e.result})),e.addEventListener("error",window.error.onLoadErrorMessage),e.readAsDataURL(t)}else window.error.onLoadErrorMessage("Ошибка загрузки файла")}));let w=!0;p.addEventListener("change",(()=>{const t=p.files[0],o=t.name.toLowerCase(),r=document.createElement("img");r.alt="Фото жилья",r.width="70",r.height="70",r.src="";const n=m.cloneNode(!0);if(n.append(r),i.append(n),w=e.some((e=>o.endsWith(e))),w){const e=new FileReader;e.addEventListener("load",(()=>{r.src=e.result})),e.addEventListener("error",window.error.onLoadErrorMessage),e.readAsDataURL(t)}else window.error.onLoadErrorMessage("Ошибка загрузки файла")}));let q=a.value,L=l.value,E=o.value,h=r.value,g=n.value,k=d.value,b=s.value;a.addEventListener("change",(()=>(q=a.value,a.setCustomValidity(""),a.style.outline="none",a.reportValidity(),q))),l.addEventListener("change",(()=>(L=l.value,a.setCustomValidity(""),a.style.outline="none",l.reportValidity(),L))),o.addEventListener("input",(e=>{E=o.value,E.length<30?(o.setCustomValidity(`Минимальная длина заголовка объявления 30 символов. Допишите ещё ${30-E.length} симв.`),o.style.outline="2px solid orange",e.preventDefault()):E.length>100?(o.setCustomValidity(`Максимальная длина заголовка объявления 100 символов. Удалите лишние ${E.length-100} симв.`),o.style.outline="2px solid orange",e.preventDefault()):(o.setCustomValidity(""),o.style.outline="none",E=o.value),o.reportValidity()})),r.addEventListener("change",(()=>(h=r.value,n.placeholder=y[""+h],n.setCustomValidity(""),n.style.outline="none",r.reportValidity(),h))),n.addEventListener("change",(()=>(g=n.value,n.placeholder=y[""+h],n.setCustomValidity(""),n.style.outline="none",n.reportValidity(),g)));let x=k===b;d.addEventListener("change",(()=>{k=d.value,b=s.value,x=k===b,x?(s.setCustomValidity(""),s.style.outline="none"):s.value=k})),s.addEventListener("change",(()=>{k=d.value,b=s.value,x=k===b,x?(s.setCustomValidity(""),s.style.outline="none"):d.value=b})),window.form={onAdFormSubmit:()=>{v[""+L].some((e=>parseInt(e,10)===parseInt(q,10)))?g>=y[""+h]?E.length<30||E.length>100?(o.setCustomValidity("Длина заголовка объявления от 30 до 100 символов."),o.style.outline="2px solid orange"):window.backend.save(new FormData(t),(()=>{window.disactivatePage(),window.error.onLoadSuccessMessage()}),window.error.onLoadFormErrorMessage):(n.setCustomValidity(_[h]),n.placeholder=y[""+h],n.style.outline="2px solid orange"):(a.setCustomValidity(f[L]),a.style.outline="2px solid orange"),t.reportValidity()},priceTypeValue:y}})(),(()=>{const e=document.querySelector(".ad-form").children,t=document.querySelectorAll("select"),o=document.querySelectorAll("input"),r=document.querySelector(".ad-form__reset"),n={LEFT:parseInt(document.querySelector(".map__pin--main").style.left,10)+32.5,TOP_INITIAL:parseInt(document.querySelector(".map__pin--main").style.top,10)+32.5,TOP:parseInt(document.querySelector(".map__pin--main").style.top,10)+87},a={bungalow:0,flat:1e3,house:5e3,palace:1e4};document.querySelector("#address").value=Math.round(n.LEFT)+", "+Math.round(n.TOP_INITIAL);const l=document.querySelector("#type").value;document.querySelector("#price").placeholder=a[l];const d=e=>{for(let t of e)"INPUT"===t.tagName?t.removeAttribute("disabled","disabled"):t.removeAttribute("disabled","true")};let s=[];const c=e=>{s=e.slice(),window.renderPins(s),window.filtersHandler(s)},u=()=>{window.backend.load(c,window.error.onLoadErrorMessage),document.querySelector(".ad-form").classList.remove("ad-form--disabled"),document.querySelector(".map").classList.remove("map--faded"),d(e),d(t),d(o),document.querySelector(".map__pin--main").querySelector("img").draggable="true",document.querySelector(".map__pin--main").removeEventListener("click",i),document.querySelector(".map__pin--main").removeEventListener("keydown",p)},i=e=>{0===e.button&&u()},p=e=>{e.preventDefault(),window.utils.isEnter(e)&&u()};document.querySelector(".map__pin--main").addEventListener("click",i),document.querySelector(".map__pin--main").addEventListener("keydown",p),document.querySelector(".ad-form").addEventListener("submit",(e=>{e.preventDefault(),window.form.onAdFormSubmit(),document.querySelector(".map__filters").reset(),document.querySelector(".ad-form").reset(),window.disactivatePage(),document.querySelector("#price").placeholder=a[l],document.querySelector(".map__pin--main").addEventListener("click",i),document.querySelector(".map__pin--main").addEventListener("keydown",p)})),r.addEventListener("click",(e=>{e.preventDefault(),document.querySelector(".map__filters").reset(),document.querySelector(".ad-form").reset(),window.disactivatePage(),document.querySelector(".ad-form-header__preview img").src="img/muffin-grey.svg",document.querySelectorAll(".ad-form__photo").forEach((e=>{e.hasChildNodes()&&e.remove()})),document.querySelector("#price").placeholder=a[l],document.querySelector(".map__pin--main").addEventListener("click",i),document.querySelector(".map__pin--main").addEventListener("keydown",p)})),r.addEventListener("keydown",(e=>{e.preventDefault(),window.utils.isEnter(e)&&(document.querySelector(".map__filters").reset(),document.querySelector(".ad-form").reset(),window.disactivatePage(),document.querySelector("#price").placeholder=a[l],document.querySelector(".map__pin--main").addEventListener("click",i),document.querySelector(".map__pin--main").addEventListener("keydown",p))}))})()})();