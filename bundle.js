(()=>{"use strict";window.utils={isEscape:e=>"Escape"===e.key,isEnter:e=>"Enter"===e.key},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o={0:"Ошибка сети, данные не загрузились",102:"Пользователь отменил запрос",400:"Неверный запрос",401:"Пользователь не авторизован",404:"Ничего не найдено",500:"Internal Server Error"},r=(e,t,r)=>{let n;switch(e.status){case 200:t(e.response);break;case e.status:n=o[e.status];break;default:n=`Cтатус ответа: ${e.status} ${e.statusText}`}n&&r(n)},n=(e,t,o)=>{e.responseType="json",e.addEventListener("load",r.bind(null,e,t,o)),e.timeout=5e3,e.addEventListener("timeout",(()=>{o(`Запрос не успел выполниться за ${e.timeout} мс`)}))};window.backend={load:(t,r)=>{const a=new XMLHttpRequest;n(a,t,r),a.addEventListener("error",(()=>{window.error.onLoadFailMessage(""+o[a.status]),window.open.disactivatePage()})),a.open("GET",e),a.send()},save:(e,o,r)=>{const a=new XMLHttpRequest;n(a,o,r),a.addEventListener("error",(e=>{e.preventDefault(),window.error.onLoadFailMessage("Ошибка сети, данные не отправились")})),a.open("POST",t),a.send(e)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=o.querySelector(".error__button"),n=o.querySelector(".error__message"),a=(e,t,o)=>{e.remove(),document.removeEventListener("keydown",t),document.removeEventListener("mousedown",o)},d=e=>{window.utils.isEscape(e)&&(e.preventDefault(),a(t,d,s))},s=e=>{e.preventDefault(),a(t,d,s)},i=()=>{a(o,l,c)},l=e=>{window.utils.isEscape(e)&&(e.preventDefault(),a(o,l,c))},c=e=>{e.preventDefault(),a(o,l,c)};window.error={onLoadSuccessMessage:()=>{e.append(t),document.addEventListener("keydown",d),document.addEventListener("mousedown",s)},onLoadFailMessage:t=>{n.textContent=t,e.append(o),r.addEventListener("click",i),document.addEventListener("keydown",l),document.addEventListener("mousedown",c)},onLoadFormFailMessage:()=>{var t,n,a,d,s;t=o,n=r,a=i,d=l,s=c,e.append(t),n.addEventListener("click",a),document.addEventListener("keydown",d),document.addEventListener("mousedown",s)},failButton:r}})(),(()=>{let e=null,t=null;const o=t=>{window.utils.isEscape(t)&&e.classList.add("hidden"),document.removeEventListener("keydown",o),document.removeEventListener("click",r)},r=()=>{e.remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",r)};window.openCards=(n,a)=>{let d=n.slice();for(let n=0;n<a.length;n++)a[n].addEventListener("click",(()=>{null!==e&&e.remove(),window.renderCard(d[n]),e=document.querySelector(".map__card"),t=e.querySelector(".popup__close"),t.addEventListener("click",r),document.addEventListener("keydown",o)}))}})(),(()=>{const e=["popup__title","popup__text--address","popup__text--price","popup__type","popup__text--capacity","popup__text--time","popup__features","popup__description","popup__photos","popup__avatar"],t=document.querySelector(".map__filters-container"),o=document.querySelector("#card").content.querySelector(".map__card"),r=o.querySelector(".popup__photo"),n={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};window.renderCard=a=>{const{offer:d,author:s}=a,{title:i,address:l,price:c,type:u,rooms:p,guests:m,checkin:y,checkout:w,description:v,features:_,photos:f}=d,{avatar:S}=s,q=o.cloneNode(!0);q.querySelector(".popup__title").textContent=i,q.querySelector(".popup__text--address").textContent=l,q.querySelector(".popup__text--price").textContent=c+"₽/ночь",q.querySelector(".popup__type").textContent=n[u],q.querySelector(".popup__text--capacity").textContent=`${p} комнаты для ${m} гостей.`,q.querySelector(".popup__text--time").textContent=`Заезд после ${y}, выезд до ${w}.`,q.querySelector(".popup__features").innerHTML="",((e,t)=>{const o=document.createDocumentFragment();e.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),o.append(t)})),t.append(o)})(_,q.querySelector(".popup__features")),q.querySelector(".popup__description").textContent=v,q.querySelector(".popup__photos").innerHTML="",((e,t)=>{const o=document.createDocumentFragment();e.forEach((e=>{const t=r.cloneNode(!0);t.src=e,o.append(t)})),t.append(o)})(f,q.querySelector(".popup__photos")),e.forEach((e=>{""===q.querySelector("."+e).innerHTML&&(q.querySelector("."+e).style.display="none")})),q.querySelector(".popup__avatar").src=S,q.querySelector(".popup__avatar").style.display="block",t.insertAdjacentElement("beforebegin",q)}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=e=>{const t=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);return t.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px;`,t.querySelector("img").src=e.author.avatar,t.querySelector("img").alt=e.offer.title,null===e.offer||void 0===e.offer?null:t},o=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove())),document.querySelectorAll(".map__card").forEach((e=>e.remove()))};window.render={displayPins:r=>{const n=r.slice(0,5);o();const a=document.createDocumentFragment();n.map(t).forEach((e=>a.append(e))),e.append(a);const d=document.querySelectorAll(".map__pin:not(.map__pin--main)");window.openCards(r,d)},removePins:o}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector("#address");e.addEventListener("mousedown",(o=>{o.preventDefault();let r={x:o.clientX,y:o.clientY};const n=(e,t)=>`${Math.floor(parseInt(e,10)+32.5)}, ${Math.floor(parseInt(t,10)+87)}`,a=o=>{o.preventDefault();let a=r.x-o.clientX,d=r.y-o.clientY;r={x:o.clientX,y:o.clientY},e.offsetTop-d>543?e.style.top="DRAG_BOTTOM - PIN_MAIN_HEIGHT px":e.offsetTop-d<43?e.style.top="DRAG_TOP - PIN_MAIN_HEIGHT px":(e.style.top=e.offsetTop-d+"px",t.value=n(e.style.left,e.style.top)),e.offsetLeft-a>1168.5?e.style.left="DRAG_RIGHT - PIN_MAIN_WIDTH / 2 px":e.offsetLeft-a<-32.5?e.style.left="DRAG_LEFT - PIN_MAIN_WIDTH / 2 px":(e.style.left=e.offsetLeft-a+"px",t.value=n(e.style.left,e.style.top))},d=o=>{o.preventDefault(),t.value=n(e.style.left,e.style.top),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",d)})),window.move={PIN_MAIN_WIDTH:65,PIN_MAIN_HEIGHT:87,mapPinMain:e,addressForm:t}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),a=e.querySelector("#housing-features"),d=e=>"any"===t.value||t.value===e.offer.type,s=e=>{const t=parseInt(e.offer.price,10);let r=!0;switch(o.value){case"any":r=!0;break;case"middle":r=t>=1e4&&t<=5e4;break;case"low":r=t<1e4;break;case"high":r=t>5e4}return r},i=e=>"any"===r.value||parseInt(r.value,10)===e.offer.rooms,l=e=>"any"===n.value||parseInt(n.value,10)===e.offer.guests,c=e=>{const t=e.offer.features,o=a.querySelectorAll("input[type=checkbox]:checked");return[].map.call(o,(e=>e.value)).every((e=>t.includes(e)))},u=window.debounce(window.render.displayPins);window.filter={strainerForPins:t=>{e.addEventListener("change",(()=>{const e=t.filter(d).filter(s).filter(i).filter(l).filter(c);u(e)}))},mapStrainers:e}})(),(()=>{const e=window.filter.mapStrainers.querySelectorAll(".map__filter"),t=window.filter.mapStrainers.querySelector(".map__features"),o=window.filter.mapStrainers.querySelectorAll(".map__checkbox"),r=document.querySelector("#type"),n=document.querySelector("#price");window.filter.mapStrainers.style.opacity="1",t.style.opacity="0.7";const a={LEFT:parseInt(document.querySelector(".map__pin--main").style.left,10)+window.move.PIN_MAIN_WIDTH/2,TOP_INITIAL:parseInt(document.querySelector(".map__pin--main").style.top,10)+window.move.PIN_MAIN_WIDTH/2,TOP:parseInt(document.querySelector(".map__pin--main").style.top,10)+window.move.PIN_MAIN_HEIGHT},d={bungalow:0,flat:1e3,house:5e3,palace:1e4},s=e=>{for(const t of e)"INPUT"===t.tagName?t.setAttribute("disabled","disabled"):t.setAttribute("disabled","true");document.querySelectorAll("input, select").forEach((e=>{e.style.outline="none"})),t.style.opacity="0.7"},i=()=>{s(document.querySelector(".ad-form").children),s(e),s(o),document.querySelector("#address").value=`${Math.round(a.LEFT)}, ${Math.round(a.TOP_INITIAL)}`,document.querySelector("#address").setAttribute("readonly","readonly");const t=r.value;n.placeholder=d[t]};i(),window.open={disactivatePage:()=>{document.querySelector(".ad-form").classList.add("ad-form--disabled"),document.querySelector(".map").classList.add("map--faded"),window.render.removePins(),i(),document.querySelector(".map__pin--main").style.left="570px",document.querySelector(".map__pin--main").style.top="375px",document.querySelectorAll(".ad-form__photo").forEach((e=>{e.hasChildNodes()&&e.remove()})),document.querySelector(".map__pin--main").addEventListener("mousedown",window.onMouseDown)},FormAddressValue:a,priceTypeValueDefault:d,selectType:r,inputPrice:n}})(),(()=>{const e=1e6,t=["gif","jpg","jpeg","png"],o=document.querySelector(".ad-form"),r=o.querySelector("#title"),n=o.querySelector("#type"),a=o.querySelector("#price"),d=o.querySelector("#capacity"),s=o.querySelector("#room_number"),i=o.querySelector("#timein"),l=o.querySelector("#timeout"),c=o.querySelector(".ad-form-header__input"),u=o.querySelector(".ad-form-header__preview img"),p=o.querySelector(".ad-form__photo-container"),m=o.querySelector(".ad-form__input"),y=o.querySelector(".ad-form__photo").cloneNode(!0);o.querySelector(".ad-form__photo").style.display="none";const w={bungalow:{price:0,errorText:"«Бунгало» — минимальная цена за ночь 0"},flat:{price:1e3,errorText:"«Квартира» — минимальная цена за ночь 1 000"},house:{price:5e3,errorText:"«Дом» — минимальная цена 5 000"},palace:{price:1e4,errorText:"«Дворец» — минимальная цена 10 000"}},v={1:{guests:["1"],errorText:"1 комната — «для 1 гостя»"},2:{guests:["1","2"],errorText:"2 комнаты — «для 2 гостей» или «для 1 гостя»"},3:{guests:["1","2","3"],errorText:"3 комнаты — «для 3 гостей», «для 2 гостей» или «для 1 гостя»"},100:{guests:["0"],errorText:"100 комнат — «не для гостей»"}},_=(e,t)=>{const o=new FileReader;o.addEventListener("load",(()=>{e.src=o.result})),o.addEventListener("error",window.error.onLoadFailMessage),o.readAsDataURL(t)},f=()=>{let e=!0;const o=c.files[0],r=o.name.toLowerCase();e=t.some((e=>r.endsWith(e))),e?(u.src="",_(u,o)):(window.error.onLoadFailMessage("Ошибка загрузки файла"),u.src="img/muffin-grey.svg")},S=()=>{let e=!0;const o=m.files[0],r=o.name.toLowerCase();if(e=t.some((e=>r.endsWith(e))),e){const e=document.createElement("img");e.alt="Фото жилья",e.width="70",e.height="70",e.src="";const t=y.cloneNode(!0);t.append(e),p.append(t),_(e,o)}else window.error.onLoadFailMessage("Ошибка загрузки файла")};c.addEventListener("change",f),m.addEventListener("change",S);const q=()=>{const t=n.value,o=parseInt(a.value,10),r=w[t];a.placeholder=r.price,a.setCustomValidity(o>=r.price&&o<=e?"":r.errorText),a.style.outline=o>=r.price&&o<=e?"none":"3px solid darkred"};n.addEventListener("change",(()=>{q(),n.reportValidity()})),a.addEventListener("input",(()=>{q(),a.reportValidity()}));const L=()=>{const e=s.value,t=d.value,o=v[e];d.setCustomValidity(o.guests.includes(t)?"":o.errorText),d.style.outline=o.guests.includes(t)?"none":"3px solid darkred"};d.addEventListener("change",(()=>{L(),d.reportValidity()})),s.addEventListener("change",(()=>{L(),s.reportValidity()}));let E=r.value;r.addEventListener("input",(e=>{E=r.value,E.length<30?(r.setCustomValidity(`Минимальная длина заголовка объявления 30 символов. Допишите ещё ${30-E.length} симв.`),r.style.outline="3px solid darkred",e.preventDefault()):E.length>100?(r.setCustomValidity(`Максимальная длина заголовка объявления 100 символов. Удалите лишние ${E.length-100} симв.`),r.style.outline="3px solid darkred",e.preventDefault()):(r.setCustomValidity(""),r.style.outline="none",E=r.value),r.reportValidity()}));let h=i.value,g=l.value,T=h===g;i.addEventListener("change",(()=>{h=i.value,g=l.value,T=h===g,T?(l.setCustomValidity(""),l.style.outline="none"):l.value=h})),l.addEventListener("change",(()=>{h=i.value,g=l.value,T=h===g,T?(l.setCustomValidity(""),l.style.outline="none"):i.value=g})),window.form={priceTypeValue:w,fileAvatarChooser:c,fileHouseChooser:m,matchOfAvatar:f,matchOfHouse:S}})(),(()=>{const e=document.querySelector(".ad-form").children,t=document.querySelectorAll("select"),o=document.querySelectorAll("input"),r=document.querySelector(".ad-form__reset"),n=e=>{for(const t of e)"INPUT"===t.tagName?t.removeAttribute("disabled","disabled"):t.removeAttribute("disabled","true");document.querySelector(".map__features").style.opacity="1"};let a=[];const d=e=>{a=e.slice(),window.render.displayPins(a),window.filter.strainerForPins(a),window.move.mapPinMain.removeEventListener("click",i),window.move.mapPinMain.removeEventListener("keydown",l)},s=()=>{window.backend.load(d,window.error.onLoadFailMessage),document.querySelector(".ad-form").classList.remove("ad-form--disabled"),document.querySelector(".map").classList.remove("map--faded"),n(e),n(t),n(o),window.move.addressForm.value=`${Math.round(window.open.FormAddressValue.LEFT)}, ${Math.round(window.open.FormAddressValue.TOP)}`,window.move.mapPinMain.querySelector("img").draggable="true"},i=e=>{0===e.button&&s()},l=e=>{e.preventDefault(),window.utils.isEnter(e)&&s()};window.move.mapPinMain.addEventListener("click",i),window.move.mapPinMain.addEventListener("keydown",l);let c=window.open.selectType.value;const u=()=>{document.querySelector(".map__filters").reset(),document.querySelector(".ad-form").reset(),window.move.addressForm.value=Math.round(window.open.FormAddressValue.LEFT)+", "+Math.round(window.open.FormAddressValue.TOP_INITIAL),c=window.open.selectType.value,window.open.inputPrice.placeholder=window.open.priceTypeValueDefault[c],document.querySelector(".ad-form-header__preview img").src="img/muffin-grey.svg",window.move.mapPinMain.addEventListener("click",i),window.move.mapPinMain.addEventListener("keydown",l)};r.addEventListener("click",(e=>{e.preventDefault(),u(),window.open.disactivatePage(),window.move.mapPinMain.addEventListener("click",i),window.move.mapPinMain.addEventListener("keydown",l)})),r.addEventListener("keydown",(e=>{e.preventDefault(),window.utils.isEnter(e)&&(u(),window.open.disactivatePage(),window.move.mapPinMain.addEventListener("click",i),window.move.mapPinMain.addEventListener("keydown",l))}));const p=()=>{window.open.disactivatePage(),window.error.onLoadSuccessMessage(),u(),window.move.mapPinMain.addEventListener("click",i),window.move.mapPinMain.addEventListener("keydown",l)};document.querySelector(".ad-form").addEventListener("submit",(e=>{e.preventDefault(),window.backend.save(new FormData(document.querySelector(".ad-form")),p,window.error.onLoadFormFailMessage)}))})()})();